<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTAV</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="main-container">
        <h1 class="logo">YTAV</h1>

        <form id="downloadForm" class="input-group">
            <div class="dropdown">
                <button class="dropdown-trigger" id="dropdownTrigger" type="button" disabled>
                    <span class="material-icons-outlined selected-icon">tune</span>
                    <span class="selected-text">Format</span>
                    <span class="material-icons-outlined chevron">expand_more</span>
                </button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item" data-format="mp4" data-quality="best" data-icon="high_quality">
                        <span class="material-icons-outlined">high_quality</span>
                        <span>Video - Max</span>
                    </div>
                    <div class="dropdown-item" data-format="mp4" data-quality="mid" data-icon="movie">
                        <span class="material-icons-outlined">movie</span>
                        <span>Video - Mid</span>
                    </div>
                    <div class="dropdown-item" data-format="mp4" data-quality="low" data-icon="sd">
                        <span class="material-icons-outlined">sd</span>
                        <span>Video - Low</span>
                    </div>
                    <div class="dropdown-item" data-format="mp3" data-quality="320" data-icon="music_note">
                        <span class="material-icons-outlined">music_note</span>
                        <span>Audio - MP3</span>
                    </div>
                    <div class="dropdown-item" data-format="wav" data-quality="" data-icon="graphic_eq">
                        <span class="material-icons-outlined">graphic_eq</span>
                        <span>Audio - WAV</span>
                    </div>
                </div>
            </div>

            <input type="text" class="url-input" id="url" name="url" placeholder="Enter URL" required>
            <input type="hidden" id="formatField" name="format" value="mp3">
            <input type="hidden" id="qualityField" name="quality" value="320">

            <button class="download-btn" id="downloadBtn" type="submit">
                <span class="material-icons-outlined">cloud_download</span>
            </button>
        </form>

        <div class="meta-panel" id="metaPanel" style="display: none;">
            <div class="meta-title" id="videoTitle"></div>
            <div class="meta-sub" id="metaSub"></div>
        </div>

        <div id="message" class="message" style="display: none;"></div>
        <div id="downloadLink" style="display: none;"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropdownTrigger = document.getElementById('dropdownTrigger');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const selectedText = dropdownTrigger.querySelector('.selected-text');
            const selectedIcon = dropdownTrigger.querySelector('.selected-icon');
            const urlInput = document.getElementById('url');
            const formatField = document.getElementById('formatField');
            const qualityField = document.getElementById('qualityField');
            const metaPanel = document.getElementById('metaPanel');
            const videoTitle = document.getElementById('videoTitle');
            const metaSub = document.getElementById('metaSub');
            const messageDiv = document.getElementById('message');
            const downloadLinkDiv = document.getElementById('downloadLink');
            const form = document.getElementById('downloadForm');
            const downloadBtn = document.getElementById('downloadBtn');

            let videoData = null;
            let fetchTimeout = null;
            let currentSelection = {
                format: 'mp3',
                quality: '320',
                icon: 'tune',
                label: 'Format',
                size: 0
            };
            let durationText = '';

            const formatIcons = {
                mp4: 'high_quality',
                mp3: 'music_note',
                wav: 'graphic_eq'
            };

            function setSelection(selection) {
                currentSelection = selection;
                selectedText.textContent = selection.label;
                selectedIcon.textContent = selection.icon || formatIcons[selection.format] || 'headphones';
                formatField.value = selection.format;
                qualityField.value = selection.quality || '';
                updateMetaInfo();
            }

            function setDropdownEnabled(enabled) {
                dropdownTrigger.disabled = !enabled;
                dropdownTrigger.classList.toggle('disabled', !enabled);
                if (!enabled) {
                    dropdownMenu.classList.remove('show');
                }
            }

            function updateMetaInfo() {
                if (!videoData) {
                    metaPanel.style.display = 'none';
                    return;
                }

                let size = 0;
                if (currentSelection.format === 'mp4') {
                    size = currentSelection.size || 0;
                } else if (currentSelection.format === 'mp3') {
                    size = videoData.audio_estimates.mp3_320;
                } else if (currentSelection.format === 'wav') {
                    size = videoData.audio_estimates.wav;
                }

                const sizeText = size > 0 ? ` | Size ~${size} MB` : '';
                metaSub.textContent = `${durationText}${sizeText}`.trim();
                metaPanel.style.display = 'block';
            }

            function buildDropdownItems(data) {
                dropdownMenu.innerHTML = '';

                if (!data || !data.success) {
                    return;
                }

                if (Array.isArray(data.video_formats) && data.video_formats.length > 0) {
                    data.video_formats.forEach(fmt => {
                        addDropdownItem({
                            label: `Video - ${fmt.quality}`,
                            icon: 'movie',
                            format: 'mp4',
                            quality: fmt.quality,
                            size: fmt.size_mb || 0
                        });
                    });
                }

                    addDropdownItem({
                        label: 'Audio - MP3',
                        icon: 'music_note',
                        format: 'mp3',
                        quality: '320',
                        size: data.audio_estimates.mp3_320
                    });

                    addDropdownItem({
                        label: 'Audio - WAV',
                        icon: 'graphic_eq',
                        format: 'wav',
                        quality: '',
                        size: data.audio_estimates.wav
                    });
            }

            function addDropdownItem({ label, icon, format, quality, size }) {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.dataset.format = format;
                item.dataset.quality = quality || '';
                item.dataset.size = size || 0;
                item.dataset.icon = icon;
                item.innerHTML = `
                    <span class="material-icons-outlined">${icon}</span>
                    <span>${label}</span>
                `;

                item.addEventListener('click', () => {
                    setSelection({
                        format,
                        quality,
                        icon,
                        label,
                        size: Number(size) || 0
                    });
                    dropdownMenu.classList.remove('show');
                });

                dropdownMenu.appendChild(item);
            }

            // Toggle dropdown
            dropdownTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdownTrigger.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });

            function handleInfoData(data) {
                videoData = data;
                if (data && data.success) {
                    videoTitle.textContent = data.title || 'Unknown title';
                    const minutes = Math.floor(data.duration / 60);
                    const seconds = data.duration % 60;
                    durationText = `Duration ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    buildDropdownItems(data);
                    setDropdownEnabled(true);

                    const firstVideo = data.video_formats && data.video_formats[0];
                    if (currentSelection.format === 'mp4' && firstVideo) {
                        setSelection({
                            format: 'mp4',
                            quality: firstVideo.quality,
                            icon: 'movie',
                            label: `Video - ${firstVideo.quality}`,
                            size: firstVideo.size_mb || 0
                        });
                    } else {
                        updateMetaInfo();
                    }
                }
            }

            async function fetchInfo(url) {
                if (!url) {
                    metaPanel.style.display = 'none';
                    videoData = null;
                    dropdownMenu.innerHTML = '';
                    setDropdownEnabled(false);
                    setSelection({
                        format: 'mp3',
                        quality: '320',
                        icon: 'tune',
                        label: 'Format',
                        size: 0
                    });
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('url', url);

                    const response = await fetch('/info', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        handleInfoData(data);
                        messageDiv.style.display = 'none';
                    } else {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = `Error: ${data.error}`;
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = `Error: ${error.message}`;
                    messageDiv.style.display = 'block';
                }
            }

            urlInput.addEventListener('input', () => {
                const url = urlInput.value.trim();
                clearTimeout(fetchTimeout);
                fetchTimeout = setTimeout(() => {
                    fetchInfo(url);
                }, 600);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const url = urlInput.value.trim();
                if (!url) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Please enter a YouTube URL';
                    messageDiv.style.display = 'block';
                    return;
                }

                messageDiv.style.display = 'none';
                downloadLinkDiv.style.display = 'none';
                downloadBtn.disabled = true;
                downloadBtn.classList.add('loading');

                const formData = new FormData();
                formData.append('url', url);
                formData.append('format', formatField.value);
                if (qualityField.value) {
                    formData.append('quality', qualityField.value);
                }

                try {
                    const response = await fetch('/download', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (data.cached) {
                            messageDiv.className = 'message success cached';
                            messageDiv.textContent = 'Serving cached file (downloaded within last 30 minutes)';
                        } else {
                            messageDiv.className = 'message success';
                            messageDiv.textContent = data.message || 'Download ready';
                        }
                        messageDiv.style.display = 'block';

                        downloadLinkDiv.innerHTML = `
                            <a href="${data.download_url}" class="download-link" download>
                                Click here to download your file
                            </a>
                        `;
                        downloadLinkDiv.style.display = 'block';
                    } else {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = `Error: ${data.error}`;
                        messageDiv.style.display = 'block';
                    }
                } catch (error) {
                    messageDiv.className = 'message error';
                    messageDiv.textContent = `Error: ${error.message}`;
                    messageDiv.style.display = 'block';
                } finally {
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('loading');
                }
            });

            setSelection(currentSelection);
            setDropdownEnabled(false);
        });
    </script>
</body>
</html>
